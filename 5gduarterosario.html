<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alice 3D - Foge da Rainha!</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', Courier, monospace; }
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 24px; pointer-events: none;
        }
        #ui-container {
            position: absolute; top: 20px; left: 20px; color: white;
            pointer-events: none; text-shadow: 2px 2px 0 #000;
        }
        #score-board { font-size: 24px; font-weight: bold; color: #ffeb3b; }
        #timer-msg { 
            font-size: 18px; color: #ff5555; margin-top: 5px; font-weight: bold; 
            opacity: 0; transition: opacity 1s;
        }
        #instructions {
            font-size: 14px; color: rgba(255,255,255,0.8);
            margin-top: 10px; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px;
        }
        .key {
            display: inline-block; border: 1px solid #fff; padding: 2px 6px;
            border-radius: 4px; font-weight: bold; font-size: 0.9em;
        }
        .overlay-screen {
            display: none;
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            z-index: 100;
            text-align: center;
        }
        #game-over {
            background: rgba(50, 0, 0, 0.8);
            color: white;
            font-size: 40px;
        }
        #victory {
            background: rgba(100, 80, 160, 0.7); 
            color: #ffd700; 
            font-size: 40px;
            text-shadow: 0 0 20px #fff;
        }
        #restart-btn-victory { display: none; }
        button {
            margin-top: 20px; padding: 10px 20px; font-size: 20px;
            cursor: pointer; background: #fff; border: none; border-radius: 5px;
            font-family: inherit;
        }
        button:hover { transform: scale(1.05); }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <div id="loading">A carregar o País das Maravilhas...</div>
    
    <div id="ui-container">
        <div id="score-board">Pontos: 0 / 150</div>
        <div id="timer-msg">O SOLDADO ACORDOU! FOGE!</div>
        <div id="instructions">
            <p>Cristal Azul: 10 pts | <span style="color: gold">Dourado: 25 pts</span></p>
            <p>Objetivo: 150 Pontos para o Coelho aparecer</p>
            <p><span class="key">↑</span> <span class="key">↓</span> Andar | <span class="key">←</span> <span class="key">→</span> Rodar</p>
        </div>
    </div>

    <div id="game-over" class="overlay-screen">
        <div>APANHADA!</div>
        <div style="font-size: 20px; margin-top: 10px">A Rainha cortou-te a cabeça!</div>
        <button onclick="location.reload()">Tentar de Novo</button>
    </div>

    <div id="victory" class="overlay-screen">
        <div>VITÓRIA!</div>
        <div id="victory-sub" style="font-size: 24px; margin-top: 10px; color: #fff;">O Coelho Branco está a chegar...</div>
        <button id="restart-btn-victory" onclick="location.reload()">Jogar Novamente</button>
    </div>

    <script>
        // --- CONFIGURAÇÃO DA CENA ---
        const scene = new THREE.Scene();
        const duskColor = 0x6a5a98; 
        scene.background = new THREE.Color(duskColor); 
        scene.fog = new THREE.FogExp2(duskColor, 0.01); 

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        const ambientLight = new THREE.HemisphereLight(0xa080ff, 0x303060, 0.7);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 0.9);
        dirLight.position.set(50, 100, 50);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // --- CHÃO ---
        function createCheckerTexture() {
            const size = 512;
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#3a3a4a'; 
            ctx.fillRect(0,0,size,size);
            ctx.fillStyle = '#4a4a6a'; 
            const step = size / 2;
            ctx.fillRect(0, 0, step, step);
            ctx.fillRect(step, step, step, step);
            const texture = new THREE.CanvasTexture(canvas);
            texture.wrapS = THREE.RepeatWrapping;
            texture.wrapT = THREE.RepeatWrapping;
            texture.repeat.set(100, 100);
            return texture;
        }

        const plane = new THREE.Mesh(
            new THREE.PlaneGeometry(1000, 1000),
            new THREE.MeshStandardMaterial({ map: createCheckerTexture() })
        );
        plane.rotation.x = -Math.PI / 2;
        plane.receiveShadow = true;
        scene.add(plane);

        // --- COGUMELOS GIGANTES ---
        function createMushroom(x, z, scale) {
            const group = new THREE.Group();
            const stem = new THREE.Mesh(
                new THREE.CylinderGeometry(1 * scale, 1.2 * scale, 8 * scale, 12),
                new THREE.MeshStandardMaterial({ color: 0xeeeeee })
            );
            stem.position.y = 4 * scale;
            stem.castShadow = true;
            group.add(stem);

            const capColor = new THREE.Color().setHSL(Math.random(), 0.7, 0.5);
            const cap = new THREE.Mesh(
                new THREE.SphereGeometry(5 * scale, 24, 12, 0, Math.PI * 2, 0, Math.PI / 2),
                new THREE.MeshStandardMaterial({ color: capColor, emissive: capColor, emissiveIntensity: 0.1 })
            );
            cap.position.y = 7.5 * scale;
            cap.castShadow = true;
            group.add(cap);

            group.position.set(x, 0, z);
            scene.add(group);
        }

        for(let i = 0; i < 40; i++) {
            const rx = (Math.random() - 0.5) * 400;
            const rz = (Math.random() - 0.5) * 400;
            if (Math.abs(rx) > 15 || Math.abs(rz) > 15) {
                createMushroom(rx, rz, 0.8 + Math.random() * 1.5);
            }
        }

        // --- ALICE ---
        const aliceGroup = new THREE.Group();
        aliceGroup.add(new THREE.Mesh(new THREE.ConeGeometry(3, 8, 32), new THREE.MeshStandardMaterial({ color: 0x3a8ecf })));
        const torso = new THREE.Mesh(new THREE.CylinderGeometry(1.5, 2.8, 4, 32), new THREE.MeshStandardMaterial({ color: 0xffffff }));
        torso.position.y = 4.5;
        aliceGroup.add(torso);
        const head = new THREE.Mesh(new THREE.SphereGeometry(2), new THREE.MeshStandardMaterial({ color: 0xffdbac }));
        head.position.y = 8;
        aliceGroup.add(head);
        aliceGroup.position.y = 4;
        aliceGroup.traverse(c => c.castShadow = true);
        scene.add(aliceGroup);

        // --- INIMIGOS (SOLDADOS) ---
        function createSoldier() {
            const group = new THREE.Group();
            const cardBody = new THREE.Mesh(new THREE.BoxGeometry(4, 7, 0.5), [
                new THREE.MeshStandardMaterial({ color: 0xaa0000 }), new THREE.MeshStandardMaterial({ color: 0xaa0000 }),
                new THREE.MeshStandardMaterial({ color: 0xaa0000 }), new THREE.MeshStandardMaterial({ color: 0xaa0000 }),
                new THREE.MeshStandardMaterial({ color: 0xffffff }), new THREE.MeshStandardMaterial({ color: 0xaa0000 })
            ]);
            group.add(cardBody);
            const enemyHead = new THREE.Mesh(new THREE.SphereGeometry(1.5), new THREE.MeshStandardMaterial({ color: 0x222222 }));
            enemyHead.position.y = 4;
            group.add(enemyHead);
            group.traverse(c => c.castShadow = true);
            return group;
        }

        const enemy1 = createSoldier();
        enemy1.position.set(0, 3.5, -60);
        enemy1.visible = false;
        scene.add(enemy1);

        const enemy2 = createSoldier();
        enemy2.position.set(60, 3.5, 60);
        enemy2.visible = false;
        scene.add(enemy2);

        // --- FLORES E CESTO ---
        function createBasket() {
            const group = new THREE.Group();
            const basket = new THREE.Mesh(new THREE.SphereGeometry(1.2, 16, 16, 0, Math.PI*2, 0, Math.PI/2), new THREE.MeshStandardMaterial({ color: 0x8b4513 }));
            basket.rotation.x = Math.PI;
            group.add(basket);
            const colors = [0xff0000, 0xffff00, 0xff00ff, 0x00ffff];
            for(let i=0; i<6; i++) {
                const flower = new THREE.Mesh(new THREE.SphereGeometry(0.4), new THREE.MeshStandardMaterial({ color: colors[i%4] }));
                flower.position.set((Math.random()-0.5)*1.2, 0.2, (Math.random()-0.5)*1.2);
                group.add(flower);
            }
            return group;
        }

        // --- COELHO ---
        function createRabbit() {
            const group = new THREE.Group();
            const body = new THREE.Mesh(new THREE.SphereGeometry(2), new THREE.MeshStandardMaterial({ color: 0xffffff }));
            group.add(body);
            const rHead = new THREE.Mesh(new THREE.SphereGeometry(1.5), new THREE.MeshStandardMaterial({ color: 0xffffff }));
            rHead.position.y = 2.5; rHead.position.z = 0.5;
            group.add(rHead);
            const earGeo = new THREE.CylinderGeometry(0.2, 0.4, 2);
            const earL = new THREE.Mesh(earGeo, new THREE.MeshStandardMaterial({ color: 0xffffff }));
            earL.position.set(-0.5, 4, 0.5); earL.rotation.z = -0.2;
            group.add(earL);
            const earR = earL.clone(); earR.position.x = 0.5; earR.rotation.z = 0.2;
            group.add(earR);
            const basket = createBasket();
            basket.position.set(0, 0.5, 2);
            group.add(basket);
            group.position.y = 2;
            return group;
        }

        // --- CRISTAIS ---
        const collectibles = [];
        function spawnCrystal(isSpecial) {
            const geo = isSpecial ? new THREE.IcosahedronGeometry(1.8) : new THREE.OctahedronGeometry(1.5);
            const mat = new THREE.MeshStandardMaterial({ 
                color: isSpecial ? 0xffd700 : 0x00ffff, 
                emissive: isSpecial ? 0xffaa00 : 0x0088aa,
                emissiveIntensity: 0.5, transparent: true, opacity: 0.8 
            });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set((Math.random()-0.5)*300, 2, (Math.random()-0.5)*300);
            mesh.userData = { points: isSpecial ? 25 : 10, offset: Math.random()*100 };
            scene.add(mesh);
            collectibles.push(mesh);
        }
        for(let i=0; i<15; i++) spawnCrystal(Math.random() > 0.8);

        // --- LÓGICA DO JOGO ---
        let score = 0, isGameOver = false, isEnemy1Active = false, isEnemy2Active = false, enemySpeed = 0.25;
        let rabbit = null, winStep = 0;
        const keys = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false };

        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => keys[e.code] = false);

        // Primeiro Soldado aos 15s
        setTimeout(() => {
            if(!isGameOver && score < 150) {
                isEnemy1Active = true; enemy1.visible = true;
                document.getElementById('timer-msg').innerText = "O SOLDADO ACORDOU! FOGE!";
                document.getElementById('timer-msg').style.opacity = 1;
            }
        }, 15000);

        // Segundo Soldado aos 25s (Novo Tempo!)
        setTimeout(() => {
            if(!isGameOver && score < 150) {
                isEnemy2Active = true; enemy2.visible = true;
                const spawnPos = new THREE.Vector3(aliceGroup.position.x + 40, 3.5, aliceGroup.position.z + 40);
                enemy2.position.copy(spawnPos);
                document.getElementById('timer-msg').innerText = "MAIS UM SOLDADO! A COISA ESTÁ A FICAR SÉRIA!";
                document.getElementById('timer-msg').style.opacity = 1;
            }
        }, 25000);

        function update() {
            if (isGameOver && winStep === 0) return;

            if (!isGameOver) {
                // Movimento Alice
                if (keys.ArrowLeft) aliceGroup.rotation.y += 0.05;
                if (keys.ArrowRight) aliceGroup.rotation.y -= 0.05;
                let move = 0;
                if (keys.ArrowUp) move = 1.2;
                if (keys.ArrowDown) move = -0.6;
                if (move !== 0) aliceGroup.translateZ(move);

                // IA Inimigo 1
                if (isEnemy1Active) {
                    enemy1.lookAt(aliceGroup.position);
                    enemy1.translateZ(enemySpeed);
                    if (aliceGroup.position.distanceTo(enemy1.position) < 6) {
                        endGame(false);
                    }
                }

                // IA Inimigo 2
                if (isEnemy2Active) {
                    enemy2.lookAt(aliceGroup.position);
                    enemy2.translateZ(enemySpeed * 1.2);
                    if (aliceGroup.position.distanceTo(enemy2.position) < 6) {
                        endGame(false);
                    }
                }

                // Cristais
                collectibles.forEach((c, i) => {
                    c.rotation.y += 0.02;
                    c.position.y = 2 + Math.sin(Date.now()*0.003 + c.userData.offset);
                    if (aliceGroup.position.distanceTo(c.position) < 5) {
                        score += c.userData.points;
                        document.getElementById('score-board').innerText = `Pontos: ${score} / 150`;
                        scene.remove(c);
                        collectibles.splice(i, 1);
                        spawnCrystal(Math.random() > 0.8);
                        if (score >= 150) {
                            startVictory();
                        }
                    }
                });
            } else if (winStep > 0) {
                if (rabbit) {
                    const dist = rabbit.position.distanceTo(aliceGroup.position);
                    if (dist > 12) {
                        rabbit.lookAt(aliceGroup.position);
                        rabbit.translateZ(0.2);
                        rabbit.position.y = 2 + Math.abs(Math.sin(Date.now()*0.01)) * 2;
                    } else {
                        rabbit.lookAt(aliceGroup.position);
                        rabbit.position.y = 2 + Math.abs(Math.sin(Date.now()*0.005)) * 1;
                    }
                }
            }

            const camOffset = new THREE.Vector3(0, 18, -25).applyMatrix4(aliceGroup.matrixWorld);
            camera.position.lerp(camOffset, 0.1);
            camera.lookAt(aliceGroup.position.x, aliceGroup.position.y + 5, aliceGroup.position.z);

            renderer.render(scene, camera);
            requestAnimationFrame(update);
        }

        function endGame(victory) {
            isGameOver = true;
            if (!victory) {
                document.getElementById('game-over').style.display = 'flex';
            }
        }

        function startVictory() {
            isGameOver = true;
            winStep = 1;
            isEnemy1Active = false;
            isEnemy2Active = false;
            scene.remove(enemy1);
            scene.remove(enemy2);
            document.getElementById('timer-msg').style.display = 'none';
            document.getElementById('victory').style.display = 'flex';

            const angle = aliceGroup.rotation.y;
            rabbit = createRabbit();
            rabbit.position.set(
                aliceGroup.position.x + Math.sin(angle) * 45,
                2,
                aliceGroup.position.z + Math.cos(angle) * 45
            );
            scene.add(rabbit);
            
            const vicLight = new THREE.PointLight(0xffffff, 1.5, 150);
            vicLight.position.set(aliceGroup.position.x, 20, aliceGroup.position.z);
            scene.add(vicLight);

            setTimeout(() => {
                document.getElementById('victory-sub').innerText = "O Coelho entregou-te as flores!";
                document.getElementById('restart-btn-victory').style.display = 'inline-block';
            }, 10000);
        }

        document.getElementById('loading').style.display = 'none';
        update();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alice no Pa√≠s das Maravilhas</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@400;700&display=swap');

        body {
            margin: 0;
            background-color: #2c0e37;
            color: #f0f0f0;
            font-family: 'Lato', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            touch-action: none;
        }

        h1 {
            font-family: 'Cinzel', serif;
            color: #e0b0ff;
            text-shadow: 0 0 10px #9400d3;
            margin: 5px 0;
            font-size: 1.5rem;
            text-align: center;
        }

        #game-container {
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
            border: 4px solid #572a6e;
            border-radius: 8px;
            background-color: #1a0521;
        }

        canvas {
            display: block;
            background-color: #2e8b57;
            max-width: 100vw;
            max-height: 70vh;
            image-rendering: pixelated;
        }

        /* Overlays */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(18, 5, 26, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            z-index: 20;
        }

        .hidden { display: none !important; }

        .btn {
            background: linear-gradient(135deg, #9400d3, #4b0082);
            border: 2px solid #e0b0ff;
            color: white;
            padding: 12px 30px;
            font-size: 1.2rem;
            font-family: 'Cinzel', serif;
            cursor: pointer;
            margin-top: 15px;
            border-radius: 5px;
            user-select: none;
        }

        .btn:active { transform: scale(0.95); }

        .instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            max-width: 90%;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Controlos de Ecr√£ */
        #controls {
            margin-top: 10px;
            display: grid;
            grid-template-columns: repeat(3, 60px);
            grid-template-rows: repeat(2, 60px);
            gap: 5px;
            justify-content: center;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid #e0b0ff;
            color: white;
            border-radius: 50%;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
       
        .control-btn:active { background: rgba(148, 0, 211, 0.6); }

        .up { grid-column: 2; grid-row: 1; }
        .left { grid-column: 1; grid-row: 2; }
        .down { grid-column: 2; grid-row: 2; }
        .right { grid-column: 3; grid-row: 2; }

        /* Mensagem do gato removida visualmente (display: none) mas mantida no c√≥digo para n√£o partir l√≥gica */
        #cat-message {
            display: none;
        }
    </style>
</head>
<body>

    <h1>Alice no Pa√≠s das Maravilhas</h1>

    <div id="game-container">
        <canvas id="gameCanvas" width="600" height="600"></canvas>
       
        <div id="cat-message"></div>

        <!-- Ecr√£ Inicial -->
        <div id="start-screen" class="overlay">
            <h2 style="color: #e0b0ff; font-family: 'Cinzel', serif;">A Busca pelo Rel√≥gio</h2>
            <div class="instructions">
                <p>Encontra o <strong>Rel√≥gio</strong> ‚åö antes que a Rainha te apanhe!</p>
                <p>Alice, tu √©s a üëß com o brilho dourado.</p>
                <p><strong>Podes atravessar paredes!</strong></p>
            </div>
            <button class="btn" onclick="startGame()">Come√ßar Jogo</button>
        </div>

        <!-- Game Over -->
        <div id="game-over-screen" class="overlay hidden">
            <h2 style="color: #ff4444;">Foste Apanhada!</h2>
            <button class="btn" onclick="startGame()">Tentar Novamente</button>
        </div>

        <!-- Win Screen -->
        <div id="win-screen" class="overlay hidden">
            <h2 style="color: #44ff44;">Vit√≥ria!</h2>
            <p>Encontraste o rel√≥gio!</p>
            <button class="btn" onclick="startGame()">Jogar Outra Vez</button>
        </div>
    </div>

    <!-- Controlos -->
    <div id="controls">
        <div class="control-btn up" onclick="handleInput('ArrowUp')">‚¨ÜÔ∏è</div>
        <div class="control-btn left" onclick="handleInput('ArrowLeft')">‚¨ÖÔ∏è</div>
        <div class="control-btn down" onclick="handleInput('ArrowDown')">‚¨áÔ∏è</div>
        <div class="control-btn right" onclick="handleInput('ArrowRight')">‚û°Ô∏è</div>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const TILE_SIZE = 30;
    const COLS = 20;
    const ROWS = 20;
   
    let gameActive = false;
    let animationId = null;
   
    let alice = { x: 1, y: 1 };
    let rabbit = { x: 1, y: 1, moveTimer: 0 };
    let watch = { x: 0, y: 0 };
    let enemies = [];
    let walls = [];
    let cat = { active: false, timer: 0, cooldown: 600 };
   
    const FOG_RADIUS = 3.5;

    window.addEventListener('keydown', function(e) {
        if(["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].indexOf(e.code) > -1) {
            e.preventDefault();
        }
        handleInput(e.key);
    });

    function startGame() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-over-screen').classList.add('hidden');
        document.getElementById('win-screen').classList.add('hidden');
       
        if (animationId) cancelAnimationFrame(animationId);
        generateLevel();
        gameActive = true;
        gameLoop();
    }

    function generateLevel() {
        walls = [];
        enemies = [];
       
        // Paredes
        for (let y = 0; y < ROWS; y++) {
            for (let x = 0; x < COLS; x++) {
                if (x === 0 || x === COLS - 1 || y === 0 || y === ROWS - 1) {
                    walls.push({x, y});
                } else if (Math.random() < 0.25) {
                    walls.push({x, y});
                }
            }
        }

        alice = { x: 1, y: 1 };
        ensureEmpty(alice.x, alice.y);

        let placed = false;
        let attempts = 0;
        while (!placed && attempts < 1000) {
            attempts++;
            let wx = Math.floor(Math.random() * (COLS - 4)) + 2;
            let wy = Math.floor(Math.random() * (ROWS - 4)) + 2;
            if (!isWall(wx, wy) && (Math.abs(wx - alice.x) + Math.abs(wy - alice.y) > 10)) {
                watch = { x: wx, y: wy };
                placed = true;
            }
        }
        if (!placed) watch = { x: COLS - 2, y: ROWS - 2 };
        ensureEmpty(watch.x, watch.y);

        rabbit = { x: alice.x, y: alice.y, moveTimer: 0 };

        spawnEnemy('queen');
        spawnEnemy('guard');
        spawnEnemy('guard');
        spawnEnemy('guard');

        cat.active = false;
        cat.timer = 0;
    }

    function spawnEnemy(type) {
        let placed = false;
        let attempts = 0;
        while (!placed && attempts < 100) {
            attempts++;
            let ex = Math.floor(Math.random() * (COLS - 2)) + 1;
            let ey = Math.floor(Math.random() * (ROWS - 2)) + 1;
            let dist = Math.abs(ex - alice.x) + Math.abs(ey - alice.y);
            if (!isWall(ex, ey) && dist > 6) {
                enemies.push({ x: ex, y: ey, type: type, moveTimer: 0 });
                placed = true;
            }
        }
    }

    function ensureEmpty(x, y) {
        walls = walls.filter(w => w.x !== x || w.y !== y);
    }

    function isWall(x, y) {
        return walls.some(w => w.x === x && w.y === y);
    }

    function handleInput(key) {
        if (!gameActive) return;
        let newX = alice.x;
        let newY = alice.y;
        if (key === 'ArrowUp') newY--;
        if (key === 'ArrowDown') newY++;
        if (key === 'ArrowLeft') newX--;
        if (key === 'ArrowRight') newX++;

        // AGORA A ALICE ATRAVESSA PAREDES (Removemos a verifica√ß√£o !isWall)
        // Apenas verificamos se ela n√£o sai do mapa
        if (newX >= 0 && newX < COLS && newY >= 0 && newY < ROWS) {
            alice.x = newX;
            alice.y = newY;
            checkCollisions();
            draw();
        }
    }

    function moveRabbit() {
        rabbit.moveTimer++;
        if (rabbit.moveTimer < 30) return;
        rabbit.moveTimer = 0;
        let dx = Math.sign(watch.x - rabbit.x);
        let dy = Math.sign(watch.y - rabbit.y);
       
        if (Math.random() < 0.8) {
            if (dx !== 0 && !isWall(rabbit.x + dx, rabbit.y)) rabbit.x += dx;
            else if (dy !== 0 && !isWall(rabbit.x, rabbit.y + dy)) rabbit.y += dy;
        } else {
            let dirs = [[0,1],[0,-1],[1,0],[-1,0]];
            let dir = dirs[Math.floor(Math.random()*dirs.length)];
            if(!isWall(rabbit.x+dir[0], rabbit.y+dir[1])) {
                rabbit.x += dir[0];
                rabbit.y += dir[1];
            }
        }
    }

    function moveEnemies() {
        enemies.forEach(enemy => {
            enemy.moveTimer++;
            let speed = enemy.type === 'queen' ? 35 : 45;
            if (enemy.moveTimer >= speed) {
                enemy.moveTimer = 0;
                let dist = Math.abs(enemy.x - alice.x) + Math.abs(enemy.y - alice.y);
                if (dist < 10 || cat.active) {
                    let dx = Math.sign(alice.x - enemy.x);
                    let dy = Math.sign(alice.y - enemy.y);
                    if (Math.abs(dx) > 0 && !isWall(enemy.x + dx, enemy.y)) enemy.x += dx;
                    else if (Math.abs(dy) > 0 && !isWall(enemy.x, enemy.y + dy)) enemy.y += dy;
                } else {
                    let dirs = [[0,1],[0,-1],[1,0],[-1,0]];
                    let dir = dirs[Math.floor(Math.random()*dirs.length)];
                    if(!isWall(enemy.x+dir[0], enemy.y+dir[1])) {
                        enemy.x += dir[0];
                        enemy.y += dir[1];
                    }
                }
            }
        });
    }

    function checkCollisions() {
        if (alice.x === watch.x && alice.y === watch.y) endGame(true);
        for(let enemy of enemies) {
            if (alice.x === enemy.x && alice.y === enemy.y) endGame(false);
        }
    }

    function updateCat() {
        cat.timer++;
        // O Gato ativa-se na mesma para limpar o nevoeiro
        if (!cat.active && cat.timer > cat.cooldown) {
            cat.active = true;
            cat.timer = 0;
            // Mensagem removida a pedido do utilizador
        }
        if (cat.active && cat.timer > 250) {
            cat.active = false;
            cat.timer = 0;
        }
    }

    // Fun√ß√£o mantida para compatibilidade, mas vazia
    function showCatMessage(text) {
        // Nada acontece
    }

    function endGame(win) {
        gameActive = false;
        cancelAnimationFrame(animationId);
        if (win) document.getElementById('win-screen').classList.remove('hidden');
        else document.getElementById('game-over-screen').classList.remove('hidden');
    }

    function draw() {
        ctx.fillStyle = '#2e8b57';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = '#1a472a';
        walls.forEach(w => {
            ctx.fillRect(w.x * TILE_SIZE, w.y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            ctx.fillStyle = '#225e36';
            ctx.fillRect(w.x * TILE_SIZE+4, w.y * TILE_SIZE+4, TILE_SIZE-8, TILE_SIZE-8);
            ctx.fillStyle = '#1a472a';
        });

        drawEmoji('‚åö', watch.x, watch.y);
        drawEmoji('üêá', rabbit.x, rabbit.y);
       
        enemies.forEach(e => {
            if (e.type === 'queen') drawEmoji('üëë', e.x, e.y);
            else drawEmoji('üÉè', e.x, e.y);
        });

        // Destaque da Alice
        let ax = alice.x * TILE_SIZE + TILE_SIZE/2;
        let ay = alice.y * TILE_SIZE + TILE_SIZE/2;
       
        ctx.beginPath();
        ctx.arc(ax, ay, TILE_SIZE/1.5, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(255, 255, 100, 0.5)';
        ctx.fill();

        ctx.beginPath();
        ctx.arc(ax, ay, TILE_SIZE/2.5, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(255, 255, 200, 0.8)';
        ctx.fill();

        drawEmoji('üëß', alice.x, alice.y);

        if (!cat.active) {
            applyFog();
        }
    }

    function drawEmoji(emoji, x, y) {
        ctx.font = `${TILE_SIZE - 4}px Arial`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = '#FFFFFF';
        ctx.fillText(emoji, x * TILE_SIZE + TILE_SIZE/2, y * TILE_SIZE + TILE_SIZE/2 + 2);
    }

    function applyFog() {
        for (let y = 0; y < ROWS; y++) {
            for (let x = 0; x < COLS; x++) {
                let dist = Math.sqrt(Math.pow(x - alice.x, 2) + Math.pow(y - alice.y, 2));
                if (dist > FOG_RADIUS) {
                    ctx.fillStyle = 'rgba(20, 5, 30, 0.98)';
                    ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                }
                else if (dist > FOG_RADIUS - 1.5) {
                    ctx.fillStyle = 'rgba(20, 5, 30, 0.5)';
                    ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                }
            }
        }
    }

    function gameLoop() {
        if (!gameActive) return;
        moveEnemies();
        moveRabbit();
        updateCat();
        checkCollisions();
        if (gameActive) {
            draw();
            animationId = requestAnimationFrame(gameLoop);
        }
    }
   
    draw();

</script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sinfonia das Maravilhas: Alice AR</title>
    <!-- Tailwind CSS para UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MediaPipe Holistic (Rosto + M√£os) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js" crossorigin="anonymous"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Playfair+Display:ital@0;1&display=swap');

        body {
            font-family: 'Playfair Display', serif;
            background-color: #0f172a;
            color: white;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        .wonderland-font {
            font-family: 'Cinzel Decorative', cursive;
        }

        /* Estilo para o Canvas espelhado */
        #output_canvas {
            transform: scaleX(-1);
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        /* Container de UI */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }

        .interactive-btn {
            pointer-events: auto;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
       
        .interactive-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }

        .interactive-btn.active {
            border: 2px solid #ffd700;
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 20px #ffd700;
        }

        #start-overlay {
            background: radial-gradient(circle, rgba(20,0,30,0.9) 0%, rgba(0,0,0,1) 100%);
            pointer-events: auto;
        }
    </style>
</head>
<body>

    <!-- Video escondido -->
    <video id="input_video" class="hidden"></video>
   
    <!-- Canvas Principal -->
    <canvas id="output_canvas"></canvas>

    <!-- UI Overlay -->
    <div id="ui-layer" class="flex flex-col justify-between p-4">
       
        <!-- Cabe√ßalho -->
        <div class="text-center mt-4 pointer-events-auto">
            <h1 class="wonderland-font text-3xl md:text-5xl text-yellow-100 drop-shadow-lg">Sinfonia & M√°scaras</h1>
            <p class="text-sm md:text-lg text-blue-200 mt-1 opacity-80 mb-2">
                ‚ÜïÔ∏è Altura = Nota Musical | ‚ÜîÔ∏è Lados = Efeitos
            </p>
        </div>

        <!-- Seletor de Personagens -->
        <div class="flex flex-wrap justify-center gap-2 md:gap-4 mb-6">
            <button onclick="setTheme('alice')" id="btn-alice" class="interactive-btn active bg-blue-900/60 border border-blue-400 text-white px-4 py-2 rounded-xl flex flex-col items-center">
                <span class="text-2xl">üë©üèº</span>
                <span class="text-xs font-bold mt-1">Alice</span>
            </button>
            <button onclick="setTheme('queen')" id="btn-queen" class="interactive-btn bg-red-900/60 border border-red-500 text-white px-4 py-2 rounded-xl flex flex-col items-center">
                <span class="text-2xl">üëë</span>
                <span class="text-xs font-bold mt-1">Rainha</span>
            </button>
            <button onclick="setTheme('hatter')" id="btn-hatter" class="interactive-btn bg-green-900/60 border border-green-500 text-white px-4 py-2 rounded-xl flex flex-col items-center">
                <span class="text-2xl">üé©</span>
                <span class="text-xs font-bold mt-1">Chapeleiro</span>
            </button>
            <button onclick="setTheme('rabbit')" id="btn-rabbit" class="interactive-btn bg-white/20 border border-white text-white px-4 py-2 rounded-xl flex flex-col items-center">
                <span class="text-2xl">üê∞</span>
                <span class="text-xs font-bold mt-1">Coelho</span>
            </button>
            <button onclick="setTheme('cat')" id="btn-cat" class="interactive-btn bg-purple-900/60 border border-purple-500 text-white px-4 py-2 rounded-xl flex flex-col items-center">
                <span class="text-2xl">üòº</span>
                <span class="text-xs font-bold mt-1">Gato</span>
            </button>
            <button onclick="setTheme('guard')" id="btn-guard" class="interactive-btn bg-gray-800/60 border border-gray-400 text-white px-4 py-2 rounded-xl flex flex-col items-center">
                <span class="text-2xl">‚ô†Ô∏è</span>
                <span class="text-xs font-bold mt-1">Guarda</span>
            </button>
        </div>
    </div>

    <!-- Tela de In√≠cio -->
    <div id="start-overlay" class="absolute inset-0 z-50 flex flex-col items-center justify-center text-center p-6">
        <h1 class="wonderland-font text-5xl md:text-7xl text-yellow-400 mb-4 animate-pulse">O Pa√≠s das Maravilhas</h1>
        <p class="text-gray-300 max-w-lg mb-8 text-lg">
            Permite o acesso √† c√¢mara.<br>
            Aumenta o som do computador.<br>
            <b>Levanta as m√£os</b> para tocar a m√∫sica!
        </p>
        <button onclick="startExperience()" class="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-500 hover:to-blue-500 text-white font-bold py-4 px-10 rounded-full shadow-lg transform transition hover:scale-110 text-xl border-2 border-white">
            ENTRAR NA TOCA DO COELHO üêá
        </button>
    </div>

    <script>
        // --- Configura√ß√£o Global ---
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        let currentTheme = 'alice';
        let audioContext = null;
        let isRunning = false;
       
        // --- Audio Engine (Sintetizador) ---
        class ThereminVoice {
            constructor() {
                this.osc = null;
                this.gainNode = null;
                this.panNode = null;
                this.filterNode = null;
                this.lfo = null;
                this.lfoGain = null;
            }

            init(ctx) {
                this.osc = ctx.createOscillator();
                this.gainNode = ctx.createGain();
                this.panNode = ctx.createStereoPanner();
                this.filterNode = ctx.createBiquadFilter();
               
                // LFO para vibrato/efeitos
                this.lfo = ctx.createOscillator();
                this.lfoGain = ctx.createGain();

                this.lfo.connect(this.lfoGain);
                this.lfoGain.connect(this.osc.frequency);

                this.osc.connect(this.filterNode);
                this.filterNode.connect(this.gainNode);
                this.gainNode.connect(this.panNode);
                this.panNode.connect(ctx.destination);

                this.gainNode.gain.value = 0;
                this.osc.start();
                this.lfo.start();
            }

            update(x, y, handType, theme) {
                if (!audioContext) return;
                const now = audioContext.currentTime;
               
                // Eixo Y (Altura) controla a nota (Pitch).
                const pitchControl = Math.max(0, 1 - y);
                // Eixo X controla o efeito/modula√ß√£o
                const effectControl = x;

                let volume = 0.4;
                let frequency, waveType, lfoFreq, lfoDepth;

                switch(theme) {
                    case 'alice':
                        waveType = 'sine';
                        frequency = 200 + (pitchControl * 1000);
                        lfoFreq = 2 + (effectControl * 5); lfoDepth = 5;
                        this.filterNode.type = 'lowpass';
                        this.filterNode.frequency.value = 500 + (effectControl * 3000);
                        break;
                   
                    case 'queen':
                        waveType = 'sawtooth';
                        frequency = 80 + (pitchControl * 500);
                        lfoFreq = 5 + (effectControl * 20); lfoDepth = 10 + (effectControl * 20);
                        this.filterNode.type = 'lowpass';
                        this.filterNode.frequency.value = 200 + (pitchControl * 2000);
                        volume = 0.35;
                        break;

                    case 'hatter':
                        waveType = 'square';
                        frequency = 150 + (pitchControl * 800);
                        lfoFreq = 10 + (Math.random() * 20);
                        lfoDepth = 30 + (effectControl * 50);
                        this.filterNode.type = 'bandpass';
                        this.filterNode.frequency.value = frequency;
                        volume = 0.3;
                        break;

                    case 'rabbit':
                        waveType = 'triangle';
                        frequency = 300 + (pitchControl * 600);
                        lfoFreq = 12 + (effectControl * 10); lfoDepth = 0;
                        if (Date.now() % 150 < 50) volume = 0.05;
                        break;

                    case 'cat':
                        waveType = 'sine';
                        frequency = 200 + (pitchControl * 800);
                        this.osc.frequency.setTargetAtTime(frequency, now, 0.3);
                        lfoFreq = 1; lfoDepth = 20 + (effectControl * 100);
                        break;
                   
                    case 'guard':
                        waveType = 'square';
                        const step = Math.floor(pitchControl * 8);
                        frequency = 110 * Math.pow(1.05946, step * 2);
                        lfoFreq = 0; lfoDepth = 0;
                        volume = 0.25;
                        break;

                    default:
                        waveType = 'sine'; frequency = 440;
                }

                this.osc.type = waveType;
                if (theme !== 'cat') {
                     this.osc.frequency.setTargetAtTime(frequency, now, 0.05);
                }
               
                this.gainNode.gain.setTargetAtTime(volume, now, 0.1);
               
                let panVal = (x * 2) - 1;
                if (handType === 'Left') panVal = -0.5;
                if (handType === 'Right') panVal = 0.5;
                this.panNode.pan.setTargetAtTime(panVal, now, 0.1);

                this.lfo.frequency.value = lfoFreq;
                this.lfoGain.gain.value = lfoDepth;
            }

            stop() {
                if(this.gainNode) this.gainNode.gain.setTargetAtTime(0, audioContext.currentTime, 0.1);
            }
        }

        const leftHandVoice = new ThereminVoice();
        const rightHandVoice = new ThereminVoice();

        // --- Gest√£o de Temas e UI ---
        function setTheme(theme) {
            currentTheme = theme;
            document.querySelectorAll('.interactive-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${theme}`).classList.add('active');
        }

        function startExperience() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            leftHandVoice.init(audioContext);
            rightHandVoice.init(audioContext);
           
            document.getElementById('start-overlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('start-overlay').style.display = 'none';
            }, 500);

            isRunning = true;
            initCamera();
        }

        // --- Visual Assets ---
        const assets = {
            alice: { color: '#60a5fa', emoji: 'üë±‚Äç‚ôÄÔ∏è', trail: 'rgba(173, 216, 230, 0.5)' },
            queen: { color: '#ef4444', emoji: 'üëë', trail: 'rgba(255, 0, 0, 0.5)' },
            hatter: { color: '#22c55e', emoji: 'üé©', trail: 'rgba(0, 255, 0, 0.5)' },
            rabbit: { color: '#ffffff', emoji: 'üêá', trail: 'rgba(255, 255, 255, 0.5)' },
            cat: { color: '#a855f7', emoji: 'üòº', trail: 'rgba(128, 0, 128, 0.5)' },
            guard: { color: '#374151', emoji: '‚ô†Ô∏è', trail: 'rgba(0, 0, 0, 0.5)' }
        };

        // --- Holistic Logic (Rosto + M√£os) ---
        function onResults(results) {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            // Efeito gato (fundo transparente)
            if (currentTheme === 'cat') {
                canvasCtx.globalAlpha = 0.6 + Math.sin(Date.now() / 500) * 0.4;
            } else {
                canvasCtx.globalAlpha = 1.0;
            }

            // Desenhar Video
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            // 1. Processar Rosto (M√°scaras apenas, sem l√≥gica de fala)
            if (results.faceLandmarks) {
                drawFaceMask(canvasCtx, results.faceLandmarks, currentTheme);
            }

            // 2. Processar M√£os e Som
            let leftActive = false;
            let rightActive = false;

            if (results.rightHandLandmarks) {
                const x = results.rightHandLandmarks[8].x;
                const y = results.rightHandLandmarks[8].y;
                const px = x * canvasElement.width;
                const py = y * canvasElement.height;
                const wx = results.rightHandLandmarks[0].x * canvasElement.width;
                const wy = results.rightHandLandmarks[0].y * canvasElement.height;
               
                drawCharacterHand(canvasCtx, px, py, wx, wy, currentTheme);
                rightHandVoice.update(1-x, y, 'Right', currentTheme);
                rightActive = true;
                createParticles(px, py, assets[currentTheme].color);
            }

            if (results.leftHandLandmarks) {
                const x = results.leftHandLandmarks[8].x;
                const y = results.leftHandLandmarks[8].y;
                const px = x * canvasElement.width;
                const py = y * canvasElement.height;
                const wx = results.leftHandLandmarks[0].x * canvasElement.width;
                const wy = results.leftHandLandmarks[0].y * canvasElement.height;

                drawCharacterHand(canvasCtx, px, py, wx, wy, currentTheme);
                leftHandVoice.update(1-x, y, 'Left', currentTheme);
                leftActive = true;
                createParticles(px, py, assets[currentTheme].color);
            }

            if (!leftActive) leftHandVoice.stop();
            if (!rightActive) rightHandVoice.stop();

            canvasCtx.restore();
        }

        // --- Desenhar M√°scaras (AR) ---
        function drawFaceMask(ctx, landmarks, theme) {
            const topHead = landmarks[10];
            const noseTip = landmarks[1];
            const leftTemple = landmarks[127];
            const rightTemple = landmarks[356];

            const w = ctx.canvas.width;
            const h = ctx.canvas.height;

            const tx = topHead.x * w;
            const ty = topHead.y * h;
            const nx = noseTip.x * w;
            const ny = noseTip.y * h;
            const lx = leftTemple.x * w;
            const rx = rightTemple.x * w;

            const faceWidth = Math.abs(rx - lx);
           
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
           
            // TRUQUE DE ESPELHO PARA EMOJIS:
            // Os emojis tamb√©m ficavam invertidos se fossem assim√©tricos.
            // Para garantir, vamos desenh√°-los invertidos tamb√©m.
            ctx.save();
            ctx.translate(nx, ny); // Mover para o nariz como centro
            ctx.scale(-1, 1);      // Inverter
           
            // Ajuste relativo (agora (0,0) √© o nariz)
            const relTy = ty - ny;

            if (theme === 'alice') {
                ctx.font = `${faceWidth * 1.5}px Arial`;
                ctx.fillText("üéÄ", 0, relTy - (faceWidth * 0.4));
               
                ctx.shadowColor = "#FFFF00";
                ctx.shadowBlur = 30;
                ctx.beginPath();
                ctx.strokeStyle = "rgba(255, 255, 0, 0.3)";
                ctx.lineWidth = 2;
                ctx.arc(0, 0, faceWidth * 0.8, 0, Math.PI * 2); // Circulo no nariz
                ctx.stroke();
            }
            else if (theme === 'queen') {
                ctx.font = `${faceWidth * 1.8}px Arial`;
                ctx.fillText("üëë", 0, relTy - (faceWidth * 0.6));
                ctx.fillStyle = "rgba(255, 0, 0, 0.3)";
                ctx.beginPath();
                ctx.arc(0, 0, faceWidth * 0.4, 0, Math.PI * 2);
                ctx.fill();
            }
            else if (theme === 'hatter') {
                ctx.font = `${faceWidth * 2.0}px Arial`;
                ctx.fillText("üé©", 0, relTy - (faceWidth * 0.8));
                ctx.beginPath();
                ctx.arc(0, 0, 10, 0, Math.PI * 2);
                ctx.fillStyle = "orange";
                ctx.fill();
            }
            else if (theme === 'rabbit') {
                ctx.font = `${faceWidth * 1.5}px Arial`;
                ctx.fillText("üê∞", 0, relTy - (faceWidth * 0.2));
            }
            else if (theme === 'cat') {
                // NOVO: M√°scara de Emoji Gigante
                ctx.font = `${faceWidth * 2.5}px Arial`;
                // Ajuste fino para ficar bem na cara
                ctx.fillText("üòº", 0, 0);
            }
            else if (theme === 'guard') {
                ctx.font = `${faceWidth * 1.5}px Arial`;
                ctx.fillText("‚ô†Ô∏è", 0, relTy);
                // Retangulo preto transl√∫cido
                ctx.fillStyle = "rgba(0,0,0,0.5)";
                ctx.fillRect(-faceWidth/2, relTy - faceWidth/2, faceWidth, faceWidth * 0.8);
            }
           
            ctx.restore();
        }

        // --- Desenhar M√£os ---
        function drawCharacterHand(ctx, x, y, wx, wy, theme) {
            const style = assets[theme];
            ctx.shadowColor = style.color;
            ctx.shadowBlur = 20;

            ctx.beginPath();
            ctx.moveTo(wx, wy);
            ctx.lineTo(x, y);
            ctx.strokeStyle = style.trail;
            ctx.lineWidth = 5;
            ctx.stroke();

            ctx.font = "50px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillStyle = "#fff";
           
            // Inverter emojis das m√£os tamb√©m
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(-1, 1);

            if (theme === 'queen') {
                ctx.fillText("‚ù§Ô∏è", 0, 0);
            } else if (theme === 'hatter') {
                ctx.fillText("‚òï", 0, 0);
            } else if (theme === 'rabbit') {
                ctx.fillText("‚åö", 0, 0);
            } else if (theme === 'guard') {
                ctx.fillText("‚öîÔ∏è", 0, 0);
            } else {
                ctx.fillText(style.emoji, 0, 0);
            }
            ctx.restore();
            ctx.shadowBlur = 0;
        }

        // --- Part√≠culas ---
        const particles = [];
        function createParticles(x, y, color) {
            if (Math.random() > 0.3) return;
            particles.push({
                x: x, y: y,
                vx: (Math.random() - 0.5) * 5,
                vy: (Math.random() - 0.5) * 5,
                life: 1.0,
                color: color
            });
        }
       
        function animateParticles() {
            if (!isRunning) { requestAnimationFrame(animateParticles); return; }
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.05;
                if (p.life <= 0) particles.splice(i, 1);
            }
            requestAnimationFrame(animateParticles);
        }
        animateParticles();

        const _drawCharacterHand = drawCharacterHand;
        drawCharacterHand = function(ctx, x, y, wx, wy, theme) {
            _drawCharacterHand(ctx, x, y, wx, wy, theme);
            particles.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.globalAlpha = p.life;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 5 * p.life, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.globalAlpha = 1.0;
        }

        // --- Inicializa√ß√£o do Holistic ---
        function initCamera() {
            const holistic = new Holistic({locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`;
            }});
           
            holistic.setOptions({
                modelComplexity: 1,
                smoothLandmarks: true,
                enableSegmentation: false,
                smoothSegmentation: false,
                refineFaceLandmarks: true,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });
           
            holistic.onResults(onResults);
           
            const camera = new Camera(videoElement, {
                onFrame: async () => {
                    await holistic.send({image: videoElement});
                },
                width: 1280,
                height: 720
            });
            camera.start();
        }

    </script>
</body>
</html>
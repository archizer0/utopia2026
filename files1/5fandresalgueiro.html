<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alice: Corrida no Pa√≠s das Maravilhas</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lato:wght@400;700&display=swap');

        body {
            margin: 0;
            padding: 0;
            background-color: #0f0518;
            overflow: hidden;
            font-family: 'Lato', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: white;
            user-select: none;
        }

        #game-container {
            position: relative;
            box-shadow: 0 0 80px rgba(138, 43, 226, 0.4);
            border-radius: 12px;
            overflow: hidden;
            width: 100%;
            max-width: 900px;
            aspect-ratio: 16/9;
            border: 4px solid #4a2c69;
            background: #000;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* UI Layer */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }

        .hud {
            display: flex;
            justify-content: space-between;
            font-family: 'Cinzel', serif;
            font-size: 22px;
            text-shadow: 2px 2px 4px #000;
            background: rgba(0,0,0,0.4);
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(4px);
        }

        /* Menus */
        .menu-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 5, 24, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
            backdrop-filter: blur(8px);
            transition: opacity 0.3s;
            z-index: 10;
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
        }

        h1 {
            font-family: 'Cinzel', serif;
            font-size: 52px;
            color: #FFD700;
            margin: 0 0 20px 0;
            text-shadow: 0 0 25px rgba(255, 215, 0, 0.5);
            text-align: center;
            line-height: 1.1;
        }

        .btn {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            border: 1px solid rgba(255,255,255,0.3);
            padding: 15px 45px;
            color: white;
            font-family: 'Cinzel', serif;
            font-size: 20px;
            border-radius: 6px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: all 0.2s;
            margin: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(110, 142, 251, 0.8);
            background: linear-gradient(135deg, #7e9efb, #b787f3);
        }

        .shop-grid {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .character-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            width: 120px;
        }

        .character-card:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .character-card.selected {
            border-color: #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
            transform: scale(1.05);
            background: rgba(255, 215, 0, 0.1);
        }

        .character-card.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .price-tag {
            color: #FFD700;
            font-weight: bold;
            margin-top: 8px;
            font-size: 14px;
        }

        .tutorial {
            color: rgba(255,255,255,0.6);
            margin-top: 25px;
            font-size: 14px;
            text-align: center;
        }
       
        /* Mobile controls hint */
        .mobile-hint {
            display: none;
        }
        @media (max-width: 768px) {
            .mobile-hint { display: block; margin-top: 10px; color: #aaa; font-size: 12px; }
            h1 { font-size: 32px; }
            .btn { padding: 12px 30px; font-size: 16px; }
        }

    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
   
    <!-- HUD -->
    <div class="ui-layer">
        <div class="hud">
            <span id="scoreDisplay">Dist: 0m</span>
            <span id="coinDisplay">üßÅ 0</span>
        </div>
    </div>

    <!-- Menu Principal -->
    <div id="mainMenu" class="menu-screen">
        <h1>Alice no Pa√≠s<br>das Maravilhas</h1>
        <button class="btn" onclick="startGame()">Come√ßar</button>
        <button class="btn" onclick="openShop()">Personagens</button>
        <div class="tutorial">
            PC: [Espa√ßo] Saltar (2x Duplo) | [Baixo] Descer<br>
            Mobile: Toque para saltar
        </div>
    </div>

    <!-- Game Over -->
    <div id="gameOverScreen" class="menu-screen hidden">
        <h1 style="color: #ff6b6b;">Fim do Jogo</h1>
        <div style="font-size: 24px; margin-bottom: 10px;">Dist√¢ncia: <span id="finalScore" style="color: #fff; font-weight: bold;">0</span>m</div>
        <div style="font-size: 20px; margin-bottom: 25px; color: gold;">Tarteletes: <span id="totalCoins">0</span></div>
        <button class="btn" onclick="resetGame()">Tentar de Novo</button>
        <button class="btn" onclick="openShop()">Loja</button>
    </div>

    <!-- Loja -->
    <div id="shopScreen" class="menu-screen hidden">
        <h1>Escolher Her√≥i</h1>
        <div class="shop-grid">
            <div class="character-card selected" onclick="selectCharacter('alice')" id="card-alice">
                <div style="font-size: 40px;">üë©üèº</div>
                <div style="margin-top:5px; font-weight:bold;">Alice</div>
                <div class="price-tag">Pronto</div>
            </div>
            <div class="character-card locked" onclick="buyCharacter('hatter', 50)" id="card-hatter">
                <div style="font-size: 40px;">üé©</div>
                <div style="margin-top:5px; font-weight:bold;">Chapeleiro</div>
                <div class="price-tag">50 üßÅ</div>
            </div>
            <div class="character-card locked" onclick="buyCharacter('rabbit', 100)" id="card-rabbit">
                <div style="font-size: 40px;">üê∞</div>
                <div style="margin-top:5px; font-weight:bold;">Coelho</div>
                <div class="price-tag">100 üßÅ</div>
            </div>
        </div>
        <div style="margin-bottom: 20px; color: gold;">Saldo: <span id="shopCoins">0</span> üßÅ</div>
        <button class="btn" onclick="closeShop()">Voltar</button>
    </div>
</div>

<script>
    /**
     * MOTOR DE JOGO "WONDERLAND ENGINE"
     */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
   
    // Configura√ß√£o de Tela
    function resize() {
        canvas.width = 900;
        canvas.height = 506;
    }
    resize();

    // Vari√°veis Globais
    let gameState = 'MENU';
    let gameSpeed = 6;
    let score = 0;
    let globalCoins = 0;
    let coinsCollectedRun = 0;
    let frame = 0;

    // Controlos
    const keys = {
        ArrowUp: false,
        ArrowDown: false,
        Space: false
    };

    // Dados das Personagens
    const characters = {
        alice: { unlocked: true, type: 'alice' },
        hatter: { unlocked: false, type: 'hatter' },
        rabbit: { unlocked: false, type: 'rabbit' }
    };
    let currentCharacter = 'alice';

    // Objetos do Jogo
    let player = null; // Inicializado como null
    let platforms = [];
    let enemies = [];
    let coins = [];
    let particles = [];
    let bgObjects = []; // Elementos decorativos de fundo

    // --- CLASSES ---

    class BackgroundObject {
        constructor() {
            this.x = Math.random() * canvas.width;
            this.y = canvas.height - Math.random() * 250; // Apenas na metade inferior
            this.size = 20 + Math.random() * 80;
            this.speedFactor = 0.2 + Math.random() * 0.4; // Movimento lento (Parallax)
            this.type = Math.random() > 0.6 ? 'mushroom' : 'tree';
            // Cores psicad√©licas escuras
            this.color = this.type === 'mushroom'
                ? `hsl(${Math.random()*360}, 50%, 30%)`
                : '#1a1025';
        }

        update() {
            this.x -= gameSpeed * this.speedFactor;
            if (this.x + this.size < -50) {
                this.x = canvas.width + 50;
                this.y = canvas.height - Math.random() * 250;
                this.type = Math.random() > 0.6 ? 'mushroom' : 'tree';
                this.color = this.type === 'mushroom' ? `hsl(${Math.random()*360}, 50%, 30%)` : '#1a1025';
            }
        }

        draw() {
            ctx.fillStyle = this.color;
            if (this.type === 'mushroom') {
                ctx.fillRect(this.x + this.size*0.4, this.y, this.size*0.2, this.size);
                ctx.beginPath();
                ctx.arc(this.x + this.size/2, this.y, this.size/2, Math.PI, 0);
                ctx.fill();
            } else {
                // √Årvore retorcida
                ctx.beginPath();
                ctx.moveTo(this.x + this.size/2, this.y - this.size);
                ctx.lineTo(this.x + this.size, this.y + this.size);
                ctx.lineTo(this.x, this.y + this.size);
                ctx.fill();
            }
        }
    }

    class Player {
        constructor() {
            this.w = 35;
            this.h = 65;
            this.x = 100;
            this.y = 200;
            this.vx = 0;
            this.vy = 0;
            this.jumpPower = -13;
            this.gravity = 0.6;
            this.grounded = false;
            this.doubleJumpAvailable = true;
            this.animTimer = 0;
        }

        update() {
            this.vy += this.gravity;
            this.y += this.vy;

            // Anima√ß√£o simples
            if (this.grounded) this.animTimer += 0.2;
            else this.animTimer = 0;

            // Saltar
            if (keys.Space || keys.ArrowUp) {
                if (this.grounded) {
                    this.vy = this.jumpPower;
                    this.grounded = false;
                    this.doubleJumpAvailable = true;
                    keys.Space = false;
                    keys.ArrowUp = false;
                    spawnParticles(this.x + this.w/2, this.y + this.h, 5, '#fff');
                } else if (this.doubleJumpAvailable) {
                    this.vy = this.jumpPower * 0.9;
                    this.doubleJumpAvailable = false;
                    keys.Space = false;
                    keys.ArrowUp = false;
                    spawnParticles(this.x + this.w/2, this.y + this.h, 8, '#FFD700'); // P√≥ m√°gico
                }
            }

            // Cair r√°pido
            if (keys.ArrowDown && !this.grounded) {
                this.vy += 1.5;
            }

            // Morte por queda
            if (this.y > canvas.height + 100) {
                endGame();
            }
        }

        draw() {
            // Efeito de "Squash & Stretch" (Esticar e Encolher)
            let sx = 1, sy = 1;
            if (!this.grounded) { sx = 0.9; sy = 1.1; }
            else if (Math.abs(this.vy) < 0.1) { sx = 1 + Math.sin(this.animTimer)*0.02; sy = 1 - Math.sin(this.animTimer)*0.02; }

            ctx.save();
            ctx.translate(this.x + this.w/2, this.y + this.h); // Piv√¥ nos p√©s
            ctx.scale(sx, sy);
            ctx.translate(-(this.x + this.w/2), -(this.y + this.h));

            const type = characters[currentCharacter].type;

            if (type === 'alice') this.drawAlice();
            else if (type === 'hatter') this.drawHatter();
            else this.drawRabbit();

            ctx.restore();
        }

        drawAlice() {
            const legMove = Math.sin(this.animTimer) * 8;
           
            // Pernas
            ctx.fillStyle = '#fff';
            ctx.fillRect(this.x + 8, this.y + 40, 8, 25 + legMove);
            ctx.fillRect(this.x + 20, this.y + 40, 8, 25 - legMove);
           
            // Meias (riscas)
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.fillRect(this.x + 8, this.y + 50, 8, 2);
            ctx.fillRect(this.x + 20, this.y + 50, 8, 2);

            // Vestido
            ctx.fillStyle = '#3498db';
            ctx.beginPath();
            ctx.moveTo(this.x + this.w/2, this.y + 20);
            ctx.lineTo(this.x - 5, this.y + 55);
            ctx.lineTo(this.x + this.w + 5, this.y + 55);
            ctx.fill();

            // Avental
            ctx.fillStyle = '#fff';
            ctx.fillRect(this.x + 10, this.y + 25, 15, 20);

            // Tronco
            ctx.fillStyle = '#3498db';
            ctx.fillRect(this.x + 10, this.y + 15, 15, 15);

            // Cabe√ßa
            ctx.fillStyle = '#ffdbac';
            ctx.beginPath();
            ctx.arc(this.x + this.w/2, this.y + 12, 10, 0, Math.PI*2);
            ctx.fill();

            // Cabelo
            ctx.fillStyle = '#f1c40f';
            ctx.beginPath();
            ctx.arc(this.x + this.w/2, this.y + 12, 11, Math.PI, Math.PI*2.2);
            ctx.fill();
        }

        drawHatter() {
            const bounce = Math.sin(this.animTimer) * 2;
           
            ctx.fillStyle = '#34495e'; // Cal√ßas
            ctx.fillRect(this.x + 8, this.y + 40, 8, 25 + bounce);
            ctx.fillRect(this.x + 20, this.y + 40, 8, 25 - bounce);

            ctx.fillStyle = '#27ae60'; // Casaco
            ctx.fillRect(this.x + 5, this.y + 25, 25, 25);

            ctx.fillStyle = '#ffdbac'; // Cara
            ctx.beginPath();
            ctx.arc(this.x + 17, this.y + 15, 9, 0, Math.PI*2);
            ctx.fill();

            ctx.fillStyle = '#2c3e50'; // Cartola
            ctx.fillRect(this.x + 5, this.y - 10, 24, 20);
            ctx.fillRect(this.x + 2, this.y + 8, 30, 4);
            ctx.fillStyle = '#fff'; // Carta 10/6
            ctx.fillRect(this.x + 20, this.y - 5, 6, 8);
        }

        drawRabbit() {
            const bounce = Math.abs(Math.sin(this.animTimer*2)) * 5;
           
            ctx.fillStyle = '#ecf0f1'; // Pelo
            ctx.beginPath();
            ctx.ellipse(this.x + 17, this.y + 40 - bounce, 14, 18, 0, 0, Math.PI*2);
            ctx.fill();

            ctx.fillStyle = '#e74c3c'; // Colete
            ctx.fillRect(this.x + 10, this.y + 30 - bounce, 14, 12);

            ctx.fillStyle = '#ecf0f1'; // Cabe√ßa
            ctx.beginPath();
            ctx.arc(this.x + 17, this.y + 20 - bounce, 11, 0, Math.PI*2);
            ctx.fill();

            ctx.fillStyle = 'pink'; // Orelhas
            ctx.fillRect(this.x + 10, this.y + 5 - bounce, 4, 12);
            ctx.fillRect(this.x + 20, this.y + 5 - bounce, 4, 12);
        }
    }

    class Platform {
        constructor(x, y, w) {
            this.x = x;
            this.y = y;
            this.w = w;
            this.h = 50;
            this.type = Math.random() > 0.7 ? 'checker' : 'grass';
        }

        draw() {
            // Sombra
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.fillRect(this.x + 10, this.y + 10, this.w, this.h);

            if (this.type === 'grass') {
                const grad = ctx.createLinearGradient(0, this.y, 0, this.y + this.h);
                grad.addColorStop(0, '#2ecc71');
                grad.addColorStop(1, '#27ae60');
                ctx.fillStyle = grad;
                ctx.fillRect(this.x, this.y, this.w, this.h);
               
                // Topo decorado
                ctx.fillStyle = '#27ae60';
                ctx.fillRect(this.x, this.y, this.w, 5);
            } else {
                // Xadrez
                ctx.fillStyle = '#fff';
                ctx.fillRect(this.x, this.y, this.w, this.h);
                ctx.fillStyle = '#8e44ad';
                const s = 25;
                for(let r=0; r<2; r++) {
                    for(let c=0; c<this.w/s; c++) {
                        if ((r+c)%2 === 0) ctx.fillRect(this.x + c*s, this.y + r*s, s, s);
                    }
                }
                ctx.strokeStyle = '#5b2c6f';
                ctx.strokeRect(this.x, this.y, this.w, this.h);
            }
        }
    }

    class Enemy {
        constructor(x, y) {
            this.x = x;
            this.y = y;
            this.w = 30;
            this.h = 45;
            this.vx = -1.5;
            this.originX = x;
            this.suit = Math.random() > 0.5 ? '‚ô•' : '‚ô†';
            this.color = this.suit === '‚ô•' ? '#c0392b' : '#2c3e50';
            this.dead = false;
            this.walkOffset = 0;
        }

        update() {
            this.x += this.vx;
            this.walkOffset += 0.2;
           
            // Patrulha simples
            if (Math.abs(this.x - this.originX) > 60) this.vx *= -1;
           
            // Move com o mundo
            this.x -= gameSpeed * 0.5;
            this.originX -= gameSpeed * 0.5;
        }

        draw() {
            if (this.dead) return;
            const wobble = Math.sin(this.walkOffset) * 0.1;
           
            ctx.save();
            ctx.translate(this.x + this.w/2, this.y + this.h);
            ctx.rotate(wobble);
            ctx.translate(-(this.x + this.w/2), -(this.y + this.h));

            // Carta
            ctx.fillStyle = '#ecf0f1';
            ctx.fillRect(this.x, this.y, this.w, this.h);
            ctx.strokeStyle = '#bdc3c7';
            ctx.strokeRect(this.x, this.y, this.w, this.h);

            // S√≠mbolo
            ctx.fillStyle = this.color;
            ctx.font = '20px Arial';
            ctx.fillText(this.suit, this.x + 8, this.y + 30);

            // Capuz/Cabe√ßa
            ctx.fillStyle = '#333';
            ctx.beginPath();
            ctx.arc(this.x + 15, this.y, 10, Math.PI, 0);
            ctx.fill();
           
            // Lan√ßa
            ctx.strokeStyle = '#95a5a6';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(this.x + 30, this.y + 10);
            ctx.lineTo(this.x + 35, this.y - 15);
            ctx.stroke();

            ctx.restore();
        }
    }

    class Coin {
        constructor(x, y) {
            this.x = x;
            this.y = y;
            this.size = 12;
            this.collected = false;
            this.t = Math.random() * 10;
        }
       
        update() {
            this.x -= gameSpeed;
            this.t += 0.1;
        }

        draw() {
            if (this.collected) return;
            const floatY = Math.sin(this.t) * 3;
           
            ctx.save();
            ctx.translate(this.x, this.y + floatY);
           
            // Brilho
            ctx.shadowColor = "#f1c40f";
            ctx.shadowBlur = 10;
           
            // Bolo
            ctx.fillStyle = '#d35400';
            ctx.beginPath();
            ctx.arc(0, 0, this.size, 0, Math.PI*2);
            ctx.fill();
           
            // Creme
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(0, -3, this.size * 0.7, 0, Math.PI*2);
            ctx.fill();
           
            // Cereja
            ctx.fillStyle = '#c0392b';
            ctx.beginPath();
            ctx.arc(0, -3, 4, 0, Math.PI*2);
            ctx.fill();
           
            ctx.restore();
        }
    }

    class Particle {
        constructor(x, y, color) {
            this.x = x;
            this.y = y;
            this.vx = (Math.random() - 0.5) * 6;
            this.vy = (Math.random() - 0.5) * 6;
            this.life = 1;
            this.color = color;
        }
        update() {
            this.x += this.vx;
            this.y += this.vy;
            this.life -= 0.05;
        }
        draw() {
            ctx.globalAlpha = this.life;
            ctx.fillStyle = this.color;
            ctx.fillRect(this.x, this.y, 4, 4);
            ctx.globalAlpha = 1;
        }
    }

    // --- L√ìGICA CORE ---

    function initGame() {
        player = new Player();
        platforms = [new Platform(0, 400, 1000)];
        enemies = [];
        coins = [];
        particles = [];
        bgObjects = [];
       
        for(let i=0; i<10; i++) bgObjects.push(new BackgroundObject());

        score = 0;
        coinsCollectedRun = 0;
        gameSpeed = 6;
        frame = 0;
       
        updateHUD();
    }

    function generateWorld() {
        const last = platforms[platforms.length - 1];
        if (last.x + last.w < canvas.width + 200) {
            const gap = 100 + Math.random() * 80;
            const w = 200 + Math.random() * 400;
            let y = last.y + (Math.random() * 100 - 50);
            y = Math.max(200, Math.min(450, y));

            const p = new Platform(last.x + last.w + gap, y, w);
            platforms.push(p);

            // Inimigos (30%)
            if (Math.random() < 0.3 && w > 150) {
                enemies.push(new Enemy(p.x + w/2, p.y - 45));
            }

            // Moedas (60%)
            if (Math.random() < 0.6) {
                const startX = p.x + 50;
                for(let i=0; i<3; i++) {
                    coins.push(new Coin(startX + i*35, y - 60 - (i===1?25:0)));
                }
            }
        }
    }

    function checkCollisions() {
        if (!player) return; // Seguran√ßa

        player.grounded = false;

        // Plataformas
        for(let p of platforms) {
            if (player.x + player.w > p.x + 10 && player.x < p.x + p.w - 10 &&
                player.y + player.h >= p.y && player.y + player.h <= p.y + p.h + player.vy + 10 &&
                player.vy >= 0) {
               
                player.grounded = true;
                player.vy = 0;
                player.y = p.y - player.h;
                player.doubleJumpAvailable = true;
            }
        }

        // Inimigos
        for(let i = enemies.length-1; i>=0; i--) {
            let e = enemies[i];
            if (e.dead) continue;

            if (rectIntersect(player.x, player.y, player.w, player.h, e.x, e.y, e.w, e.h)) {
                // Matar se cair de cima
                if (player.vy > 0 && player.y + player.h < e.y + e.h/2 + 10) {
                    e.dead = true;
                    player.vy = -10; // Salto
                    score += 50;
                    spawnParticles(e.x, e.y, 10, '#c0392b');
                    enemies.splice(i, 1);
                } else {
                    endGame();
                }
            }
        }

        // Moedas
        for(let c of coins) {
            if (!c.collected && rectIntersect(player.x, player.y, player.w, player.h, c.x-10, c.y-10, 20, 20)) {
                c.collected = true;
                coinsCollectedRun++;
                spawnParticles(c.x, c.y, 6, '#f1c40f');
            }
        }
    }

    function rectIntersect(x1, y1, w1, h1, x2, y2, w2, h2) {
        return x2 < x1 + w1 && x2 + w2 > x1 && y2 < y1 + h1 && y2 + h2 > y1;
    }

    function spawnParticles(x, y, n, c) {
        for(let i=0; i<n; i++) particles.push(new Particle(x, y, c));
    }

    // Loop Principal
    function update() {
        if (gameState !== 'PLAYING') return;

        player.update();
        generateWorld();
       
        bgObjects.forEach(b => b.update());
        platforms.forEach(p => p.x -= gameSpeed);
        enemies.forEach(e => e.update());
        coins.forEach(c => c.update());
        particles.forEach(p => p.update());

        // Limpeza
        platforms = platforms.filter(p => p.x + p.w > -100);
        enemies = enemies.filter(e => e.x > -100);
        coins = coins.filter(c => c.x > -100 && !c.collected);
        particles = particles.filter(p => p.life > 0);

        checkCollisions();

        score += gameSpeed / 20;
        gameSpeed += 0.001; // Acelera√ß√£o gradual
        updateHUD();
        frame++;
    }

    function draw() {
        // Fundo
        const grad = ctx.createLinearGradient(0,0,0,canvas.height);
        grad.addColorStop(0, '#2c3e50');
        grad.addColorStop(1, '#4a2c69');
        ctx.fillStyle = grad;
        ctx.fillRect(0,0,canvas.width, canvas.height);

        // Lua
        ctx.fillStyle = 'rgba(255,255,220,0.2)';
        ctx.beginPath();
        ctx.arc(canvas.width - 150, 100, 40, 0, Math.PI*2);
        ctx.fill();

        bgObjects.forEach(b => b.draw());

        if (player) {
            platforms.forEach(p => p.draw());
            coins.forEach(c => c.draw());
            enemies.forEach(e => e.draw());
            player.draw();
            particles.forEach(p => p.draw());
        }
    }

    function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
    }

    // --- UI & FLUXO ---

    function startGame() {
        document.getElementById('mainMenu').classList.add('hidden');
        document.getElementById('gameOverScreen').classList.add('hidden');
        document.getElementById('shopScreen').classList.add('hidden');
        gameState = 'PLAYING';
        initGame();
    }

    function endGame() {
        gameState = 'GAMEOVER';
        globalCoins += coinsCollectedRun;
        document.getElementById('finalScore').innerText = Math.floor(score);
        document.getElementById('totalCoins').innerText = globalCoins;
        document.getElementById('shopCoins').innerText = globalCoins;
        document.getElementById('gameOverScreen').classList.remove('hidden');
    }

    function resetGame() {
        startGame();
    }

    function updateHUD() {
        document.getElementById('scoreDisplay').innerText = `Dist: ${Math.floor(score)}m`;
        document.getElementById('coinDisplay').innerText = `üßÅ ${coinsCollectedRun}`;
    }

    // Fun√ß√µes da Loja
    function openShop() {
        document.getElementById('mainMenu').classList.add('hidden');
        document.getElementById('gameOverScreen').classList.add('hidden');
        document.getElementById('shopScreen').classList.remove('hidden');
        document.getElementById('shopCoins').innerText = globalCoins;
        updateShopCards();
    }

    function closeShop() {
        document.getElementById('shopScreen').classList.add('hidden');
        document.getElementById('mainMenu').classList.remove('hidden');
    }

    function updateShopCards() {
        ['alice', 'hatter', 'rabbit'].forEach(id => {
            const el = document.getElementById(`card-${id}`);
            el.className = 'character-card';
           
            if (currentCharacter === id) el.classList.add('selected');
            else if (!characters[id].unlocked) el.classList.add('locked');
        });
    }

    function buyCharacter(id, price) {
        if (characters[id].unlocked) {
            currentCharacter = id;
            updateShopCards();
            return;
        }
        if (globalCoins >= price) {
            globalCoins -= price;
            characters[id].unlocked = true;
            document.getElementById('shopCoins').innerText = globalCoins;
            document.querySelector(`#card-${id} .price-tag`).innerText = "Pronto";
            currentCharacter = id;
            updateShopCards();
        } else {
            alert("N√£o tens tarteletes suficientes!");
        }
    }

    function selectCharacter(id) {
        if (characters[id].unlocked) {
            currentCharacter = id;
            updateShopCards();
        }
    }

    // Listeners
    window.addEventListener('keydown', e => {
        if (e.code === 'Space') keys.Space = true;
        if (e.code === 'ArrowUp') keys.ArrowUp = true;
        if (e.code === 'ArrowDown') keys.ArrowDown = true;
    });

    window.addEventListener('keyup', e => {
        if (e.code === 'Space') keys.Space = false;
        if (e.code === 'ArrowUp') keys.ArrowUp = false;
        if (e.code === 'ArrowDown') keys.ArrowDown = false;
    });

    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        keys.Space = true;
    });
    canvas.addEventListener('touchend', (e) => {
        e.preventDefault();
        keys.Space = false;
    });

    // Iniciar
    loop();

</script>
</body>
</html>

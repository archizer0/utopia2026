<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alice's Card Game - Hand Tracking</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000b1a;
            color: #e0f2fe;
            font-family: 'Georgia', serif;
        }
        canvas { display: block; }
        .video-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 160px;
            height: 120px;
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid #0ea5e9;
            transform: scaleX(-1);
            z-index: 10;
        }
        #ui-layer {
            position: absolute;
            top: 20px;
            left: 20px;
            pointer-events: none;
            z-index: 20;
        }
        #lyrics-display {
            position: fixed;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.8rem;
            color: #7dd3fc;
            text-shadow: 0 0 15px rgba(125, 211, 252, 0.9);
            text-align: center;
            font-style: italic;
            background: rgba(0,0,0,0.6);
            padding: 15px 30px;
            border-radius: 30px;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 30;
        }
        #status-log {
            position: fixed;
            top: 20px;
            right: 200px;
            font-size: 12px;
            color: #38bdf8;
            background: rgba(0,0,0,0.3);
            padding: 5px;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <div id="status-log">A aguardar início...</div>

    <div id="ui-layer">
        <h1 class="text-2xl font-bold text-sky-400">Alice: Sueca Mágica</h1>
        <div class="mt-2 text-sm text-sky-200 opacity-80">Velocidade: <span id="speed-val">0</span></div>
        <div class="w-48 h-2 bg-sky-900 rounded-full mt-1">
            <div id="speed-bar" class="h-full bg-sky-400 w-0 transition-all duration-100"></div>
        </div>
    </div>

    <div id="lyrics-display"></div>

    <div id="setup-screen" class="fixed inset-0 flex items-center justify-center bg-black/90 z-50">
        <div class="text-center p-10 bg-blue-900/30 border border-sky-500/50 rounded-3xl backdrop-blur-xl max-w-lg">
            <h1 class="text-5xl font-bold text-sky-300 mb-6">Alice Azul</h1>
            <p class="text-xl text-sky-100 mb-4">"Mova as mãos para ver as cartas e ouvir a canção."</p>
            <p class="text-sm text-sky-400/70 mb-8 italic">Certifique-se que a sua câmara está ligada e bem iluminada.</p>
            <button id="startBtn" class="bg-sky-600 hover:bg-sky-400 text-white px-12 py-4 rounded-full text-xl font-bold transition-all shadow-[0_0_20px_rgba(14,165,233,0.5)] hover:scale-105 active:scale-95">
                COMEÇAR JOGO
            </button>
        </div>
    </div>

    <div class="video-container">
        <video id="input_video" playsinline></video>
    </div>
   
    <canvas id="canvas_output"></canvas>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('canvas_output');
        const canvasCtx = canvasElement.getContext('2d');
        const lyricsDisplay = document.getElementById('lyrics-display');
        const speedVal = document.getElementById('speed-val');
        const speedBar = document.getElementById('speed-bar');
        const statusLog = document.getElementById('status-log');

        let audioStarted = false;
        let synth, filter;
        let cards = [];
        let lastPos = { x: 0, y: 0 };
        let currentSpeed = 0;
        let lyricIndex = 0;

        const lyrics = [
            "Alice in Wonderland",
            "How do you get to Wonderland?",
            "Over the hill or underland",
            "Or just behind the moon?",
            "Wonderland where stars come down",
            "To dance upon the golden ground",
            "Alice in Wonderland"
        ];

        const cardSuits = ['♠', '♣', '♥', '♦'];
        const cardValues = ['A', 'K', 'J', 'Q', '7', '6', '5'];

        function log(msg) {
            statusLog.innerText = msg;
            console.log(msg);
        }

        function speakLyric(text) {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel(); // Limpa fila
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.8 + (currentSpeed * 0.4);
            utterance.pitch = 1.1;
            window.speechSynthesis.speak(utterance);
           
            lyricsDisplay.innerText = text;
            lyricsDisplay.style.opacity = 1;
            setTimeout(() => { lyricsDisplay.style.opacity = 0; }, 2500);
        }

        async function initAudio() {
            try {
                await Tone.start();
                const reverb = new Tone.Reverb(4).toDestination();
                filter = new Tone.Filter(1500, "lowpass").connect(reverb);
                synth = new Tone.PolySynth(Tone.AMSynth).connect(filter);
                audioStarted = true;
                log("Áudio Inicializado.");
               
                // Ciclo de letras
                setInterval(() => {
                    if(currentSpeed > 0.15 && audioStarted) {
                        speakLyric(lyrics[lyricIndex]);
                        lyricIndex = (lyricIndex + 1) % lyrics.length;
                    }
                }, 4500);
            } catch (e) {
                log("Erro no Áudio: " + e);
            }
        }

        class Card {
            constructor(x, y, speed) {
                this.x = x;
                this.y = y;
                this.val = cardValues[Math.floor(Math.random() * cardValues.length)];
                this.suit = cardSuits[Math.floor(Math.random() * cardSuits.length)];
                this.vx = (Math.random() - 0.5) * 25 * speed;
                this.vy = (Math.random() - 0.5) * 20 * speed - 8;
                this.rotation = Math.random() * Math.PI * 2;
                this.vr = (Math.random() - 0.5) * 0.3;
                this.life = 1.0;
                this.color = (this.suit === '♥' || this.suit === '♦') ? '#ef4444' : '#1e293b';
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.25; // gravidade
                this.rotation += this.vr;
                this.life -= 0.012;
            }
            draw() {
                canvasCtx.save();
                canvasCtx.translate(this.x, this.y);
                canvasCtx.rotate(this.rotation);
                canvasCtx.globalAlpha = this.life;
               
                // Sombra da carta
                canvasCtx.shadowBlur = 10;
                canvasCtx.shadowColor = "rgba(0,0,0,0.5)";

                // Fundo da carta
                canvasCtx.fillStyle = '#ffffff';
                canvasCtx.beginPath();
                canvasCtx.roundRect(-25, -35, 50, 70, 6);
                canvasCtx.fill();
               
                canvasCtx.shadowBlur = 0;
                canvasCtx.strokeStyle = '#0ea5e9';
                canvasCtx.lineWidth = 2;
                canvasCtx.stroke();
               
                // Texto
                canvasCtx.fillStyle = this.color;
                canvasCtx.font = 'bold 20px serif';
                canvasCtx.fillText(this.val, -20, -12);
                canvasCtx.font = '24px serif';
                canvasCtx.fillText(this.suit, -10, 20);
               
                canvasCtx.restore();
            }
        }

        function onResults(results) {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;

            // Fundo
            const grad = canvasCtx.createRadialGradient(canvasElement.width/2, canvasElement.height/2, 0, canvasElement.width/2, canvasElement.height/2, canvasElement.width);
            grad.addColorStop(0, '#001a33');
            grad.addColorStop(1, '#00050a');
            canvasCtx.fillStyle = grad;
            canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                log("Mão detectada!");
                const hand = results.multiHandLandmarks[0];
                const indexTip = hand[8];
                const x = (1 - indexTip.x) * canvasElement.width;
                const y = indexTip.y * canvasElement.height;

                const dx = x - lastPos.x;
                const dy = y - lastPos.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
               
                currentSpeed = currentSpeed * 0.85 + (Math.min(dist/80, 1)) * 0.15;
                speedVal.innerText = Math.round(currentSpeed * 100);
                speedBar.style.width = (currentSpeed * 100) + "%";

                if (currentSpeed > 0.1) {
                    if (Math.random() < currentSpeed * 0.4) {
                        cards.push(new Card(x, y, currentSpeed));
                    }
                   
                    if(audioStarted) {
                        filter.frequency.rampTo(400 + (currentSpeed * 6000), 0.1);
                        if(Math.random() > 0.92) {
                            const notes = ["C4", "Eb4", "G4", "Bb4", "C5"];
                            synth.triggerAttackRelease(notes[Math.floor(Math.random()*notes.length)], "8n");
                        }
                    }
                }
                lastPos = { x, y };

                // Brilho da mão
                canvasCtx.shadowBlur = 40 * currentSpeed;
                canvasCtx.shadowColor = "#0ea5e9";
                canvasCtx.fillStyle = "white";
                canvasCtx.beginPath();
                canvasCtx.arc(x, y, 6, 0, Math.PI*2);
                canvasCtx.fill();
                canvasCtx.shadowBlur = 0;
            }

            cards = cards.filter(c => c.life > 0);
            cards.forEach(c => { c.update(); c.draw(); });
        }

        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 640,
            height: 480
        });

        document.getElementById('startBtn').addEventListener('click', async () => {
            log("A iniciar câmara...");
            document.getElementById('setup-screen').style.display = 'none';
            await initAudio();
            camera.start().then(() => log("Câmara Ativa.")).catch(e => log("Erro Câmara: " + e));
        });

        window.addEventListener('resize', () => {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
        });
    </script>
</body>
</html>
